# INTMAX Node Monitoring Wiki

## このプロジェクトについて

INTMAX Block Builderを運用する際、以下のような課題に直面することがあります：

| 課題 | 解決策 |
|------|--------|
| 複数ノードの確認が面倒 | ダッシュボードで全ノードを一括表示 |
| ノード停止に気づきにくい | ステータス監視とアラート |
| 報酬がどれだけ貯まったか分からない | ETH/sITX残高のグラフ表示 |
| ウォレットのガス代が心配 | 残高監視と履歴表示 |
| 報酬回収を忘れる | 自動回収スクリプト（オプション） |

## Block Builder運用フロー

```
┌──────────────────┐
│ 1. ノードセットアップ │  ← 公式builder.shで起動
└────────┬─────────┘
         ↓
┌──────────────────┐
│ 2. 監視          │  ← このプロジェクト
│   - サーバー構築  │
│   - エージェント設定│
└────────┬─────────┘
         ↓
┌──────────────────┐
│ 3. 運用          │
│   - ダッシュボード │
│   - 報酬確認      │
│   - 自動回収      │
└──────────────────┘
```

## セットアップガイド

### ステップ1: Block Builderを起動

Block Builderをまだ起動していない場合は、[INTMAX Block Builderについて](About-INTMAX)を参照してセットアップしてください。

### ステップ2: 監視サーバーをセットアップ

[サーバーセットアップ](Setup-Server)に従って、Prometheus + Grafana環境を構築します。

### ステップ3: 各ノードにエージェントをインストール

[ノードセットアップ](Setup-Node)に従って、各対象ノードにエージェントをインストールします。

### ステップ4: 報酬監視を設定（オプション）

ETH報酬とウォレット残高を監視するには、[報酬](Rewards)を参照してください。

## 目次

### はじめに
| ページ | 説明 |
|--------|------|
| [INTMAX Block Builderについて](About-INTMAX) | Block Builderの概要、セットアップ、報酬構造 |
| [サーバーセットアップ](Setup-Server) | Prometheus + Grafanaのセットアップ |
| [ノードセットアップ](Setup-Node) | 各ノードへのエージェントセットアップ |

### 運用
| ページ | 説明 |
|--------|------|
| [報酬](Rewards) | 報酬監視と自動回収 |
| [メトリクスリファレンス](Metrics) | 収集されるメトリクスの完全なリストとPromQL例 |
| [アップグレード](Upgrading) | 監視システムのアップグレード方法 |

### リファレンス
| ページ | 説明 |
|--------|------|
| [セキュリティベストプラクティス](Security) | セキュリティ推奨事項とハードニング |
| [Raspberry Pi](Raspberry-Pi) | 対応モデルと注意事項 |
| [トラブルシューティング & FAQ](Troubleshooting) | よくある問題、解決策、よくある質問 |

## システムアーキテクチャ

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            監視サーバー                                      │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         Docker Compose                               │   │
│  │                                                                      │   │
│  │  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐  │   │
│  │  │   Prometheus    │    │     Grafana     │    │ Wallet Exporter │  │   │
│  │  │   (port 9090)   │◄───│   (port 3000)   │    │   (port 9101)   │  │   │
│  │  │                 │    │                 │    │                 │  │   │
│  │  │  • 時系列DB     │    │  • ダッシュボード │    │  • ETH残高     │  │   │
│  │  │  • アラートルール│    │  • アラート      │    │  • sITX残高    │  │   │
│  │  │  • 90日保持     │    │  • グラフ        │    │  • Scroll RPC  │  │   │
│  │  └────────┬────────┘    └─────────────────┘    └────────┬────────┘  │   │
│  │           │                                              │           │   │
│  │           │  15秒ごとにスクレイプ                        │ HTTP/RPC  │   │
│  │           │                                              │           │   │
│  │  ┌────────┴────────┐                           ┌────────▼────────┐  │   │
│  │  │ Reward Exporter │                           │  Scrollネットワーク│  │   │
│  │  │   (port 9102)   │                           │                 │  │   │
│  │  │                 │                           │  (ブロックチェーン)│  │   │
│  │  │  • ノードへSSH  │                           └─────────────────┘  │   │
│  │  │  • CLI残高取得  │                                                │   │
│  │  └────────┬────────┘                                                │   │
│  │           │ SSH                                                     │   │
│  └───────────┼─────────────────────────────────────────────────────────┘   │
│              │                                                              │
└──────────────┼──────────────────────────────────────────────────────────────┘
               │
               │ メトリクス取得 (HTTP :9100)
               │
    ┌──────────┴──────────┬───────────────────┬───────────────────┐
    │                     │                   │                   │
    ▼                     ▼                   ▼                   ▼
┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐ ┌───────────┐
│   ノード 1       │ │   ノード 2       │ │   ノード 3       │ │  ノード N  │
│ ┌─────────────┐ │ │ ┌─────────────┐ │ │ ┌─────────────┐ │ │           │
│ │Block Builder│ │ │ │Block Builder│ │ │ │Block Builder│ │ │    ...    │
│ │  (Docker)   │ │ │ │  (Docker)   │ │ │ │  (Docker)   │ │ │           │
│ └─────────────┘ │ │ └─────────────┘ │ │ └─────────────┘ │ │           │
│ ┌─────────────┐ │ │ ┌─────────────┐ │ │ ┌─────────────┐ │ │           │
│ │node_exporter│ │ │ │node_exporter│ │ │ │node_exporter│ │ │           │
│ │ (port 9100) │ │ │ │ (port 9100) │ │ │ │ (port 9100) │ │ │           │
│ └─────────────┘ │ │ └─────────────┘ │ │ └─────────────┘ │ │           │
│ ┌─────────────┐ │ │ ┌─────────────┐ │ │ ┌─────────────┐ │ │           │
│ │メトリクスCron│ │ │ │メトリクスCron│ │ │ │メトリクスCron│ │ │           │
│ │ (1-5分)     │ │ │ │ (1-5分)     │ │ │ │ (1-5分)     │ │ │           │
│ └─────────────┘ │ │ └─────────────┘ │ │ └─────────────┘ │ │           │
└─────────────────┘ └─────────────────┘ └─────────────────┘ └───────────┘
```

## データフロー

```
┌────────────────────────────────────────────────────────────────────────────┐
│                              データフロー                                   │
├────────────────────────────────────────────────────────────────────────────┤
│                                                                            │
│  1. ノードメトリクス収集（1〜5分ごと）                                       │
│     ┌──────────────────┐     ┌──────────────────┐     ┌────────────────┐  │
│     │ intmax_builder_  │     │ node_exporter    │     │ Prometheus     │  │
│     │ metrics.sh       │────▶│ textfile_collector│────▶│ (スクレイプ)   │  │
│     │ (cronジョブ)     │     │ (:9100/metrics)  │     │                │  │
│     └──────────────────┘     └──────────────────┘     └────────────────┘  │
│                                                                            │
│  2. ウォレット残高（1時間ごと）                                             │
│     ┌──────────────────┐     ┌──────────────────┐     ┌────────────────┐  │
│     │ Scrollネットワーク│     │ wallet-exporter  │     │ Prometheus     │  │
│     │ (JSON-RPC)       │◀────│ eth_getBalance   │────▶│ (スクレイプ)   │  │
│     │                  │     │ balanceOf(sITX)  │     │                │  │
│     └──────────────────┘     └──────────────────┘     └────────────────┘  │
│                                                                            │
│  3. 報酬残高（1時間ごと）                                                   │
│     ┌──────────────────┐     ┌──────────────────┐     ┌────────────────┐  │
│     │ Builderノード    │     │ reward-exporter  │     │ Prometheus     │  │
│     │ (INTMAX CLI)     │◀────│ SSH + balanceコマンド│────▶│ (スクレイプ)   │  │
│     │                  │     │                  │     │                │  │
│     └──────────────────┘     └──────────────────┘     └────────────────┘  │
│                                                                            │
│  4. 可視化                                                                  │
│     ┌──────────────────┐     ┌──────────────────┐                         │
│     │ Prometheus       │     │ Grafana          │                         │
│     │ (時系列DB)       │────▶│ (ダッシュボード)  │────▶  ユーザーブラウザ  │
│     │                  │     │                  │                         │
│     └──────────────────┘     └──────────────────┘                         │
│                                                                            │
└────────────────────────────────────────────────────────────────────────────┘
```

## コンポーネント詳細

| コンポーネント | ポート | 目的 | 更新間隔 |
|---------------|--------|------|----------|
| Prometheus | 9090 | 時系列データベース、アラート評価 | 15秒スクレイプ |
| Grafana | 3000 | ダッシュボード可視化 | リアルタイム |
| Wallet Exporter | 9101 | ScrollからETH/sITXウォレット残高取得 | 1時間 |
| Reward Exporter | 9102 | SSH経由で保留中報酬取得 | 1時間 |
| node_exporter | 9100 | システムおよびカスタムメトリクス | 15秒スクレイプ |
| メトリクスCron | - | Docker/プロセス状態収集 | 1〜5分 |
